<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Natty Daddy Counter</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0c10">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root { --bg:#0b0c10; --card:#14161b; --text:#e8edf2; --accent:#5aa9ff; --muted:#9aa3ad; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .wrap { max-width: 520px; margin: 0 auto; padding: 16px 16px 28px; display: flex; flex-direction: column; gap: 16px; }
  header h1 { font-size: 20px; margin: 0; letter-spacing: 0.2px; }
  .card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 8px 20px rgba(0,0,0,.25); }
  .big-button { display: grid; place-items: center; border: none; background: transparent; padding: 8px; cursor: pointer; user-select: none; }
  .big-button:active svg { transform: scale(0.98); }
  .can { width: 100%; max-width: 340px; height: auto; }
  .counters { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }
  .counter { background: #0f1116; border: 1px solid #1c2028; border-radius: 12px; padding: 12px; text-align: center; }
  .counter .label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; }
  .counter .value { font-size: 32px; font-weight: 700; margin-top: 4px; }
  .meta { font-size: 12px; color: var(--muted); text-align: center; margin-top: 4px; }
  .history { margin-top: 8px; }
  .history h2 { font-size: 14px; color: var(--muted); margin: 0 0 8px; letter-spacing: .04em; text-transform: uppercase; }
  .list { display: grid; gap: 6px; }
  .row { display: flex; justify-content: space-between; background:#0f1116; border:1px solid #1c2028; border-radius:10px; padding:8px 10px; }
  .row .d { color: var(--text); }
  .row .n { font-weight: 700; }
  .controls { display:flex; gap:8px; justify-content:center; margin-top:10px; }
  .btn { background:#0f1116; border:1px solid #273042; color: var(--text); padding:10px 12px; border-radius:10px; font-size:14px; cursor:pointer; }
  .btn:active { transform: translateY(1px); }
  img, svg { -webkit-user-drag: none; user-select: none; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Natty Daddy Counter</h1>
      <div class="meta">Tap the can to add 1. Day resets at 6:00 AM.</div>
    </header>

    <div class="card" id="tap-card" aria-live="polite">
      <button class="big-button" id="tapBtn" title="Add one">
        <!-- simplified “Natty” can SVG -->
        <svg class="can" viewBox="0 0 240 520" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Natty can">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#dfeaf6"/>
              <stop offset="100%" stop-color="#b9cbe2"/>
            </linearGradient>
          </defs>
          <rect x="40" y="20" width="160" height="480" rx="26" fill="url(#g)" stroke="#8ea5c2" stroke-width="3"/>
          <ellipse cx="120" cy="24" rx="72" ry="14" fill="#c5d3e6" stroke="#8ea5c2" stroke-width="2"/>
          <path d="M20 230 L220 190 L220 250 L20 290 Z" fill="#3b7cff" opacity="0.9"/>
          <path d="M20 300 L220 260 L220 300 L20 340 Z" fill="#ff4d4d" opacity="0.85"/>
          <g transform="translate(48,150) rotate(-12)">
            <text x="0" y="0" font-size="48" font-weight="800" fill="#1f3b63" font-family="Arial Black, Impact, system-ui">NATTY</text>
            <text x="8" y="44" font-size="28" font-weight="700" fill="#1f3b63" font-family="Arial Black, Impact, system-ui">LIGHT</text>
          </g>
          <circle id="ripple" cx="120" cy="260" r="0" fill="none" stroke="#5aa9ff" stroke-width="6" opacity="0.0"/>
        </svg>
      </button>

      <div class="counters">
        <div class="counter">
          <div class="label">Today</div>
          <div class="value" id="todayCount">0</div>
        </div>
        <div class="counter">
          <div class="label">Last 30 Days</div>
          <div class="value" id="rolling30">0</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="undoBtn" title="Undo last">Undo</button>
        <button class="btn" id="zeroTodayBtn" title="Set today to zero">Zero Today</button>
      </div>

      <div class="meta" id="beerDayLabel"></div>
    </div>

    <div class="card history">
      <h2>Recent days</h2>
      <div class="list" id="historyList"></div>
    </div>
  </div>

<script>
(function() {
  const STORAGE_KEY = 'nattyDaddy.v1';
  const SIX_AM = 6;

  function beerDayKey(d = new Date()) {
    const dt = new Date(d);
    if (dt.getHours() < SIX_AM) dt.setDate(dt.getDate() - 1);
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const day = String(dt.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { countsByDay:{}, lastEvents:[] };
      const parsed = JSON.parse(raw);
      return { countsByDay: parsed.countsByDay || {}, lastEvents: parsed.lastEvents || [] };
    } catch(e) {
      console.warn('State parse error, resetting.', e);
      return { countsByDay:{}, lastEvents:[] };
    }
  }

  function saveState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function addOne() {
    const k = beerDayKey();
    const s = loadState();
    s.countsByDay[k] = (s.countsByDay[k] || 0) + 1;
    s.lastEvents.push(Date.now());
    if (s.lastEvents.length > 200) s.lastEvents.splice(0, s.lastEvents.length-200);
    pruneOlderThan30Days(s);
    saveState(s);
    animateRipple();
    render();
  }

  function undoOne() {
    const s = loadState();
    if (s.lastEvents.length === 0) return;
    const k = beerDayKey();
    if ((s.countsByDay[k] || 0) > 0) {
      s.countsByDay[k] -= 1;
    } else {
      const keys = lastNDaysKeys(30);
      for (let i=1; i<keys.length; i++) {
        const kk = keys[i];
        if ((s.countsByDay[kk] || 0) > 0) { s.countsByDay[kk]-=1; break; }
      }
    }
    s.lastEvents.pop();
    pruneOlderThan30Days(s);
    saveState(s);
    render();
  }

  function zeroToday() {
    const s = loadState();
    const k = beerDayKey();
    s.countsByDay[k] = 0;
    saveState(s);
    render();
  }

  function pruneOlderThan30Days(state) {
    const keep = new Set(lastNDaysKeys(30));
    for (const k of Object.keys(state.countsByDay)) if (!keep.has(k)) delete state.countsByDay[k];
  }

  function lastNDaysKeys(n) {
    const keys = [];
    let cursor = new Date();
    for (let i=0; i<n; i++) { keys.push(beerDayKey(cursor)); cursor.setDate(cursor.getDate() - 1); }
    return [...new Set(keys)];
  }

  function rolling30Total(state) {
    const keys = lastNDaysKeys(30);
    return keys.reduce((sum,k)=> sum + (state.countsByDay[k] || 0), 0);
  }

  function formatLabelKey(k) {
    const [y,m,d] = k.split('-').map(Number);
    const dt = new Date(y, m-1, d);
    const opts = { weekday:'short', month:'short', day:'numeric' };
    return dt.toLocaleDateString(undefined, opts);
  }

  function animateRipple() {
    const r = document.getElementById('ripple');
    r.setAttribute('r','0'); r.setAttribute('opacity','0.4'); r.style.transition = 'none';
    requestAnimationFrame(()=>{ r.style.transition = 'r 450ms ease-out, opacity 520ms ease-out'; r.setAttribute('r','180'); r.setAttribute('opacity','0.0'); });
  }

  function render() {
    const s = loadState();
    const k = beerDayKey();
    document.getElementById('todayCount').textContent = s.countsByDay[k] || 0;
    document.getElementById('rolling30').textContent = rolling30Total(s);
    document.getElementById('beerDayLabel').textContent = `Today = ${formatLabelKey(k)} (beer day runs 6:00 AM → 5:59:59 AM)`;

    const histWrap = document.getElementById('historyList');
    histWrap.innerHTML = '';
    const keys = lastNDaysKeys(7);
    keys.forEach((kk, idx) => {
      const row = document.createElement('div'); row.className = 'row';
      const d = document.createElement('div'); d.className = 'd';
      d.textContent = formatLabelKey(kk) + (idx === 0 ? ' (today)' : '');
      const n = document.createElement('div'); n.className = 'n'; n.textContent = (loadState().countsByDay[kk] || 0);
      row.appendChild(d); row.appendChild(n); histWrap.appendChild(row);
    });
  }

  // Register service worker for PWA behavior
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }

  // Auto-refresh around the 6AM boundary
  let lastKey = beerDayKey();
  setInterval(() => {
    const nowKey = beerDayKey();
    if (nowKey !== lastKey) { lastKey = nowKey; render(); }
  }, 30 * 1000);

  document.getElementById('tapBtn').addEventListener('click', addOne, { passive: true });
  document.getElementById('undoBtn').addEventListener('click', undoOne, { passive: true });
  document.getElementById('zeroTodayBtn').addEventListener('click', zeroToday, { passive: true });
  render();
})();
</script>
</body>
</html>
